# AgSys Protocol Tests

This directory contains tests for validating protocol encoding/decoding between C firmware and Go property controller.

## Test Strategy

### Layer 1: Device ↔ Property Controller (LoRa Protocol)

**C Firmware Tests** (`protocol_test.c`)
- Validates struct packing and byte layout
- Ensures message types match protocol spec
- Outputs hex dumps for visual inspection

**Go Protocol Tests** (`internal/protocol/messages_test.go`)
- Unit tests for all payload encode/decode functions
- Validates message type constants
- Tests error handling for malformed data

**Cross-Validation Tests** (`internal/protocol/cross_validation_test.go`)
- C generates test vectors with known values → JSON
- Go reads JSON and validates decoding matches expected values
- Go encodes same values and compares with C encoding
- **This ensures C and Go are byte-compatible**

### Layer 2: Property Controller ↔ Backend (gRPC)

**Engine Tests** (`internal/engine/engine_test.go`)
- Database storage tests (alarms, readings, devices)
- Message flow simulation tests
- Config update flow validation

### Layer 3: End-to-End (Future)

- LoRa message simulation with mock radio
- Full pipeline: device → controller → cloud → database

## Running Tests

### C Protocol Tests

```bash
cd devices/common/test
make test
```

### Generate Test Vectors (for cross-validation)

```bash
cd devices/common/test
make vectors
```

This creates `test_vectors.json` which is used by Go cross-validation tests.

### Go Tests

```bash
cd devices/property-controller
make test
# or
go test -v ./...
```

### Run Specific Test Categories

```bash
# Protocol encoding/decoding only
go test -v ./internal/protocol/...

# Cross-validation only
go test -v ./internal/protocol/... -run CrossValidate

# Storage/engine tests only
go test -v ./internal/engine/...
```

## Test Vector Format

The `test_vectors.json` file contains test cases generated by C code:

```json
{
  "meter_alarms": [
    {
      "timestamp": 12345,
      "alarm_type": 1,
      "flow_rate_lpm": 150,
      "duration_sec": 3600,
      "total_liters": 50000,
      "flags": 1,
      "encoded": "39300000019600100e000050c3000001"
    }
  ],
  ...
}
```

The `encoded` field is the hex representation of the C struct bytes (little-endian).

## Adding New Tests

### When adding a new message type:

1. Add C struct to `agsys_protocol.h`
2. Add test case to `protocol_test.c`
3. Add test vector generation to `generate_test_vectors.c`
4. Add Go struct and encode/decode to `messages.go`
5. Add Go unit test to `messages_test.go`
6. Add cross-validation test to `cross_validation_test.go`
7. Regenerate test vectors: `make vectors`
8. Run all tests to verify compatibility

## Continuous Integration

Recommended CI pipeline:

```yaml
test-protocol:
  steps:
    - cd devices/common/test && make test
    - cd devices/common/test && make vectors
    - cd devices/property-controller && go test -v ./...
```

## Troubleshooting

### "Test vectors file not found"

Run `make vectors` in `devices/common/test` to generate the JSON file.

### Encoding mismatch between C and Go

1. Check struct packing (`__attribute__((packed))` in C)
2. Verify byte order (should be little-endian)
3. Check field sizes match (uint16_t = uint16, etc.)
4. Use hex dumps to compare byte-by-byte
