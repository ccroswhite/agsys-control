/**
 * @file ble_service.h
 * @brief BLE Service for Valve Controller
 * 
 * Provides BLE characteristics for:
 * - Device info (UID, firmware version)
 * - Valve control (open/close/stop)
 * - CAN bus discovery
 * - Actuator status
 */

#ifndef BLE_SERVICE_H
#define BLE_SERVICE_H

#include <Arduino.h>
#include <bluefruit.h>

// Include shared BLE authentication
#include "agsys_ble_auth.h"

// Custom Service UUID: AgSys Valve Controller
// Base: 12345678-1234-5678-1234-56789ABCDEF0
#define BLE_UUID_VALVE_SERVICE          "12340001-1234-5678-1234-56789ABCDEF0"

// Characteristic UUIDs (auth uses shared AGSYS UUIDs from agsys_ble_auth.h)
#define BLE_UUID_DEVICE_INFO            "12340002-1234-5678-1234-56789ABCDEF0"  // Read: UID, version
#define BLE_UUID_VALVE_COMMAND          "12340003-1234-5678-1234-56789ABCDEF0"  // Write: valve commands (auth required)
#define BLE_UUID_VALVE_STATUS           "12340004-1234-5678-1234-56789ABCDEF0"  // Read/Notify: actuator status
#define BLE_UUID_CAN_DISCOVERY          "12340005-1234-5678-1234-56789ABCDEF0"  // Write: trigger (auth required)
#define BLE_UUID_ACTUATOR_LIST          "12340006-1234-5678-1234-56789ABCDEF0"  // Read: discovered actuators

// Command opcodes (for VALVE_COMMAND characteristic)
#define BLE_CMD_VALVE_OPEN              0x01
#define BLE_CMD_VALVE_CLOSE             0x02
#define BLE_CMD_VALVE_STOP              0x03
#define BLE_CMD_VALVE_QUERY             0x04
#define BLE_CMD_EMERGENCY_CLOSE         0x0F

// Discovery command opcodes (for CAN_DISCOVERY characteristic)
#define BLE_CMD_DISCOVER_START          0x01
#define BLE_CMD_DISCOVER_STATUS         0x02

// Discovery status
#define BLE_DISCOVERY_IDLE              0x00
#define BLE_DISCOVERY_IN_PROGRESS       0x01
#define BLE_DISCOVERY_COMPLETE          0x02
#define BLE_DISCOVERY_ERROR             0xFF

// Authentication uses shared library constants from agsys_ble_auth.h:
// - AGSYS_PIN_LENGTH (6 digits)
// - AGSYS_AUTH_* status codes
// - AGSYS_PIN_MAX_ATTEMPTS, AGSYS_PIN_LOCKOUT_MS, AGSYS_AUTH_TIMEOUT_MS

// Actuator info structure (for BLE transmission)
typedef struct __attribute__((packed)) {
    uint8_t  address;           // CAN address (1-64)
    uint8_t  uid[8];            // Unique ID
    uint8_t  state;             // Valve state
    uint8_t  flags;             // Status flags
} BleActuatorInfo;

// Initialize BLE service
void ble_init(void);

// Start/stop advertising
void ble_startAdvertising(void);
void ble_stopAdvertising(void);

// Check connection status
bool ble_isConnected(void);

// Process BLE events (call from loop)
void ble_process(void);

// Update actuator status (triggers notification if subscribed)
void ble_updateActuatorStatus(uint8_t address, uint8_t state, uint16_t currentMa);

// Set discovery results (called after CAN discovery completes)
void ble_setDiscoveryResults(uint8_t count);

// Check if current session is authenticated
bool ble_isAuthenticated(void);

// Set the device PIN (stored in FRAM)
void ble_setPin(const uint8_t* pin);

// Load PIN from FRAM
void ble_loadPin(void);

#endif // BLE_SERVICE_H
