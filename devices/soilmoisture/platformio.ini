; PlatformIO Configuration for Soil Moisture Sensor
; Target: Nordic nRF52832 with BLE OTA support
;
; Build targets:
;   pio run -e debug          # Debug build (no APPROTECT)
;   pio run -e release        # Release build (APPROTECT enabled)
;   pio run -e adafruit_feather_nrf52832  # Default dev board

[platformio]
default_envs = debug

; Common settings for all environments
[env]
platform = nordicnrf52
framework = arduino
lib_deps = 
    sandeepmistry/LoRa@^0.8.0
    rweather/Crypto@0.4.0
    adafruit/Adafruit SPIFlash@^4.3.4
    adafruit/Adafruit FRAM SPI@^2.0.0
; Adafruit BusIO requires Wire.h stub - auto-copied by extra_scripts
lib_ignore = Wire
extra_scripts = pre:copy_wire_stub.py
upload_protocol = nrfutil
monitor_speed = 115200

; =============================================================================
; DEBUG BUILD - For development, debugging enabled
; =============================================================================
[env:debug]
board = adafruit_feather_nrf52832
build_flags = 
    -D NRF52832_XXAA
    -D CFG_us915=1
    -D LORA_FREQUENCY=915E6
    -D DEBUG_BUILD=1
    -D CFG_DEBUG=1
    -O0 -g3
build_type = debug

; =============================================================================
; RELEASE BUILD - For production, APPROTECT enabled
; =============================================================================
[env:release]
board = adafruit_feather_nrf52832
build_flags = 
    -D NRF52832_XXAA
    -D CFG_us915=1
    -D LORA_FREQUENCY=915E6
    -D RELEASE_BUILD=1
    -D CFG_DEBUG=0
    -Os
    -DNDEBUG
build_type = release

; =============================================================================
; DEVELOPMENT BOARDS
; =============================================================================
[env:adafruit_feather_nrf52832]
board = adafruit_feather_nrf52832
build_flags = 
    -D NRF52832_XXAA
    -D CFG_us915=1
    -D LORA_FREQUENCY=915E6
    -D DEBUG_BUILD=1
    -D CFG_DEBUG=1

[env:sparkfun_nrf52832_breakout]
board = sparkfun_nrf52832_breakout
build_flags = 
    -D NRF52832_XXAA
    -D CFG_us915=1
    -D LORA_FREQUENCY=915E6
    -D DEBUG_BUILD=1
    -D CFG_DEBUG=1

; =============================================================================
; TEST BUILD - Cycles through synthetic sensor readings for controller testing
; =============================================================================
; Usage: pio run -e test-cycle-readings
;
; Sends synthetic moisture/temperature data every TEST_TX_INTERVAL_MS
; Moisture cycles 0% -> 100% -> 0% in steps of TEST_MOISTURE_STEP
; Useful for testing LoRa reception and protocol handling on controller
;
[env:test-cycle-readings]
board = adafruit_feather_nrf52832
build_flags = 
    -D NRF52832_XXAA
    -D CFG_us915=1
    -D LORA_FREQUENCY=915E6
    -D DEBUG_BUILD=1
    -D CFG_DEBUG=1
    -D TEST_MODE_CYCLE_READINGS=1
    -D TEST_TX_INTERVAL_MS=5000
    -D TEST_MOISTURE_STEP=5
build_type = debug

; =============================================================================
; TEST BUILD - Power profiling (sensor, LoRa TX, deep sleep phases)
; =============================================================================
; Usage: pio run -e test-power-all
;
; Cycles through phases for power measurement:
;   Phase 1: Sensor active (H-bridge, ADC) - 60 seconds
;   Phase 2: LoRa TX continuous - 60 seconds
;   Phase 3: Deep sleep - 60 seconds
; Repeats forever
;
[env:test-power-all]
board = adafruit_feather_nrf52832
build_flags = 
    -D NRF52832_XXAA
    -D CFG_us915=1
    -D LORA_FREQUENCY=915E6
    -D DEBUG_BUILD=1
    -D CFG_DEBUG=1
    -D TEST_MODE_POWER_ALL=1
    -D TEST_PHASE_DURATION_MS=60000
build_type = debug

; =============================================================================
; TEST BUILD - Failback test (good firmware - baseline)
; =============================================================================
; Usage: pio run -e test-failback-good
;
; Normal firmware that marks itself as validated.
; Use as baseline before testing rollback with test-failback-bad.
; Version: 99.0.0 (easy to identify)
;
[env:test-failback-good]
board = adafruit_feather_nrf52832
build_flags = 
    -D NRF52832_XXAA
    -D CFG_us915=1
    -D LORA_FREQUENCY=915E6
    -D DEBUG_BUILD=1
    -D CFG_DEBUG=1
    -D TEST_MODE_FAILBACK_GOOD=1
    -D FW_VERSION_MAJOR=99
    -D FW_VERSION_MINOR=0
    -D FW_VERSION_PATCH=0
build_type = debug

; =============================================================================
; TEST BUILD - Failback test (bad firmware - triggers rollback)
; =============================================================================
; Usage: pio run -e test-failback-bad
;
; Intentionally broken firmware that never calls firmware_markValid().
; After OTA update, will timeout and rollback to previous firmware.
; Version: 99.1.0 (easy to identify)
;
[env:test-failback-bad]
board = adafruit_feather_nrf52832
build_flags = 
    -D NRF52832_XXAA
    -D CFG_us915=1
    -D LORA_FREQUENCY=915E6
    -D DEBUG_BUILD=1
    -D CFG_DEBUG=1
    -D TEST_MODE_FAILBACK_BAD=1
    -D FW_VERSION_MAJOR=99
    -D FW_VERSION_MINOR=1
    -D FW_VERSION_PATCH=0
build_type = debug

; =============================================================================
; TEST BUILD - H-Bridge Frequency Test
; =============================================================================
; Usage: pio run -e test-frequency
;
; Test build for evaluating different AC excitation frequencies for soil
; moisture sensing. Provides BLE API to set frequency and trigger measurements.
;
; BLE Characteristics:
;   - Frequency (R/W): Set H-bridge frequency in Hz (100kHz - 4MHz)
;   - Trigger (W): Write 0x01 to take measurement
;   - Result (R/N): Raw ADC value
;   - Moisture (R/N): Moisture percentage
;
[env:test-frequency]
board = adafruit_feather_nrf52832
build_flags = 
    -D NRF52832_XXAA
    -D CFG_us915=1
    -D LORA_FREQUENCY=915E6
    -D DEBUG_BUILD=1
    -D CFG_DEBUG=1
    -D TEST_MODE_FREQUENCY=1
    -D FW_VERSION_MAJOR=1
    -D FW_VERSION_MINOR=0
    -D FW_VERSION_PATCH=0
build_type = debug
