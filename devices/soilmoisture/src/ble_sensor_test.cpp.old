/**
 * @file ble_sensor_test.cpp
 * @brief BLE Sensor Test Service implementation
 */

#include "ble_sensor_test.h"
#include "capacitance.h"
#include "config.h"
#include <string.h>

// Custom UUID base: 12340000-1234-5678-9ABC-DEF012345678
const uint8_t BLESensorTestService::UUID128_BASE[16] = {
    0x78, 0x56, 0x34, 0x12, 0xF0, 0xDE, 0xBC, 0x9A,
    0x78, 0x56, 0x34, 0x12, 0x00, 0x00, 0x34, 0x12
};

// Global instance
BLESensorTestService bleSensorTest;

// Static pointer for callbacks
static BLESensorTestService* s_instance = nullptr;

BLESensorTestService::BLESensorTestService() 
    : BLEService(UUID128_BASE),
      _frequencyChar(UUID128_BASE),
      _triggerChar(UUID128_BASE),
      _resultChar(UUID128_BASE),
      _moistureChar(UUID128_BASE)
{
    s_instance = this;
    
    // Set characteristic UUIDs
    uint8_t uuid[16];
    
    memcpy(uuid, UUID128_BASE, 16);
    uuid[12] = SENSOR_TEST_UUID_FREQUENCY & 0xFF;
    uuid[13] = (SENSOR_TEST_UUID_FREQUENCY >> 8) & 0xFF;
    _frequencyChar.setUuid(uuid);
    
    memcpy(uuid, UUID128_BASE, 16);
    uuid[12] = SENSOR_TEST_UUID_TRIGGER & 0xFF;
    uuid[13] = (SENSOR_TEST_UUID_TRIGGER >> 8) & 0xFF;
    _triggerChar.setUuid(uuid);
    
    memcpy(uuid, UUID128_BASE, 16);
    uuid[12] = SENSOR_TEST_UUID_RESULT & 0xFF;
    uuid[13] = (SENSOR_TEST_UUID_RESULT >> 8) & 0xFF;
    _resultChar.setUuid(uuid);
    
    memcpy(uuid, UUID128_BASE, 16);
    uuid[12] = SENSOR_TEST_UUID_MOISTURE & 0xFF;
    uuid[13] = (SENSOR_TEST_UUID_MOISTURE >> 8) & 0xFF;
    _moistureChar.setUuid(uuid);
}

err_t BLESensorTestService::begin() {
    VERIFY_STATUS(BLEService::begin());
    
    // Frequency characteristic (read/write uint32)
    _frequencyChar.setProperties(CHR_PROPS_READ | CHR_PROPS_WRITE);
    _frequencyChar.setPermission(SECMODE_OPEN, SECMODE_OPEN);
    _frequencyChar.setFixedLen(4);
    _frequencyChar.setWriteCallback(frequencyWriteCallback);
    VERIFY_STATUS(_frequencyChar.begin());
    
    // Set initial frequency value
    uint32_t freq = hbridgeGetFrequency();
    _frequencyChar.write32(freq);
    
    // Trigger characteristic (write uint8)
    _triggerChar.setProperties(CHR_PROPS_WRITE);
    _triggerChar.setPermission(SECMODE_NO_ACCESS, SECMODE_OPEN);
    _triggerChar.setFixedLen(1);
    _triggerChar.setWriteCallback(triggerWriteCallback);
    VERIFY_STATUS(_triggerChar.begin());
    
    // Result characteristic (read/notify uint16)
    _resultChar.setProperties(CHR_PROPS_READ | CHR_PROPS_NOTIFY);
    _resultChar.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
    _resultChar.setFixedLen(2);
    VERIFY_STATUS(_resultChar.begin());
    _resultChar.write16(0);
    
    // Moisture characteristic (read/notify uint8)
    _moistureChar.setProperties(CHR_PROPS_READ | CHR_PROPS_NOTIFY);
    _moistureChar.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
    _moistureChar.setFixedLen(1);
    VERIFY_STATUS(_moistureChar.begin());
    _moistureChar.write8(0);
    
    return ERROR_NONE;
}

void BLESensorTestService::updateResults(uint16_t rawAdc, uint8_t moisturePercent) {
    _resultChar.write16(rawAdc);
    _resultChar.notify16(rawAdc);
    
    _moistureChar.write8(moisturePercent);
    _moistureChar.notify8(moisturePercent);
}

uint32_t BLESensorTestService::getFrequency() {
    return hbridgeGetFrequency();
}

void BLESensorTestService::frequencyWriteCallback(uint16_t conn_hdl, BLECharacteristic* chr, uint8_t* data, uint16_t len) {
    (void)conn_hdl;
    (void)chr;
    
    if (len >= 4) {
        uint32_t requestedFreq = data[0] | (data[1] << 8) | (data[2] << 16) | (data[3] << 24);
        uint32_t actualFreq = hbridgeSetFrequency(requestedFreq);
        
        // Update characteristic with actual frequency achieved
        if (s_instance) {
            s_instance->_frequencyChar.write32(actualFreq);
        }
        
        Serial.printf("BLE: Frequency set to %lu Hz (requested %lu Hz)\n", actualFreq, requestedFreq);
    }
}

void BLESensorTestService::triggerWriteCallback(uint16_t conn_hdl, BLECharacteristic* chr, uint8_t* data, uint16_t len) {
    (void)conn_hdl;
    (void)chr;
    
    if (len >= 1 && data[0] == 1) {
        Serial.printf("BLE: Triggering measurement at %lu Hz\n", hbridgeGetFrequency());
        
        // Perform measurement
        uint16_t rawAdc = readCapacitance();
        uint8_t moisture = capacitanceToMoisturePercent(rawAdc);
        
        Serial.printf("BLE: Result - Raw: %u, Moisture: %u%%\n", rawAdc, moisture);
        
        // Update result characteristics
        if (s_instance) {
            s_instance->updateResults(rawAdc, moisture);
        }
    }
}
